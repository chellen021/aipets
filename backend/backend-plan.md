# 萌宠伙伴微信小程序后端开发规划

## 项目概述
基于《萌宠伙伴微信小程序后端开发设计规范》和相关文档，制定详细的后端开发实施计划。

## 技术栈
- **编程语言**: Node.js + TypeScript
- **Web框架**: NestJS
- **数据库**: 
  - PostgreSQL (用户数据、订单数据)
  - MongoDB (宠物数据)
  - Redis (缓存、会话)
- **消息队列**: RabbitMQ
- **容器化**: Docker
- **API文档**: Swagger/OpenAPI

## 开发阶段规划

### 阶段一：项目基础设施搭建 (1-2天)

#### 1.1 项目初始化 ✅
- [x] 创建NestJS项目结构
- [x] 配置TypeScript和ESLint
- [x] 设置项目目录结构
- [x] 配置环境变量管理
- [x] 初始化Git仓库和.gitignore

#### 1.2 数据库配置 🔄
- [x] 配置PostgreSQL连接
- [x] 配置MongoDB连接
- [x] 配置Redis连接
- [ ] 设置数据库迁移工具
- [ ] 创建基础数据库表结构

#### 1.3 基础中间件配置 ✅
- [x] 配置CORS
- [x] 配置请求日志中间件
- [x] 配置全局异常处理
- [x] 配置请求验证管道
- [x] 配置Swagger文档

### 阶段二：用户认证系统 (2-3天)

#### 2.1 用户认证服务 ✅
- [x] 实现微信登录接口 `/auth/wechat_login`
- [x] 实现JWT Token生成和验证
- [x] 实现会话检查接口 `/auth/check_session`
- [x] 配置JWT认证守卫
- [x] 实现Token刷新机制

#### 2.2 用户数据模型 ✅
- [x] 创建User实体和数据表
- [x] 创建UserSettings实体和数据表
- [x] 创建UserLoginLogs实体和数据表
- [x] 实现用户数据访问层(Repository)
- [ ] 编写用户认证相关单元测试

### 阶段三：用户服务模块 (2天)

#### 3.1 用户信息管理 ✅
- [x] 实现获取用户信息接口 `/users/profile`
- [x] 实现更新用户信息接口 `/users/profile`
- [x] 实现头像上传接口 `/users/avatar`
- [x] 实现用户设置管理接口 `/users/settings`
- [x] 添加敏感词过滤功能

#### 3.2 文件上传服务 ✅
- [x] 配置对象存储服务(OSS/S3)
- [x] 实现文件上传中间件
- [x] 实现图片处理功能(压缩、格式转换)
- [x] 添加文件类型和大小验证
- [x] 编写文件上传相关测试

### 阶段四：宠物服务模块 (3-4天)

#### 4.1 宠物数据模型 ⬜
- [ ] 创建Pet MongoDB集合和Schema
- [ ] 创建PetInteraction MongoDB集合和Schema
- [ ] 实现宠物数据访问层
- [ ] 配置MongoDB连接和ODM
- [ ] 设置宠物状态计算逻辑

#### 4.2 宠物生成功能 ⬜
- [ ] 实现照片上传接口 `/pets/upload_photo`
- [ ] 实现宠物生成接口 `/pets/generate`
- [ ] 实现宠物确认领养接口 `/pets`
- [ ] 集成AI服务接口(模拟或真实)
- [ ] 实现宠物模型数据生成逻辑

#### 4.3 宠物信息管理 ⬜
- [ ] 实现获取用户宠物列表接口 `/users/pets`
- [ ] 实现获取宠物详情接口 `/pets/{pet_id}`
- [ ] 实现宠物状态自动衰减逻辑
- [ ] 添加宠物数据缓存机制
- [ ] 编写宠物服务相关测试

### 阶段五：互动服务模块 (2-3天)

#### 5.1 宠物互动功能 ⬜
- [ ] 实现宠物互动接口 `/pets/{pet_id}/interact`
- [ ] 实现互动类型处理逻辑(喂食、抚摸、玩耍、清洁、训练)
- [ ] 实现道具消耗和效果计算
- [ ] 实现宠物状态更新逻辑
- [ ] 实现经验值和等级计算

#### 5.2 互动记录管理 ⬜
- [ ] 实现互动日志记录功能
- [ ] 实现获取互动历史接口
- [ ] 添加互动频率限制
- [ ] 实现互动奖励系统
- [ ] 编写互动服务相关测试

### 阶段六：签到服务模块 (1-2天)

#### 6.1 签到功能 ⬜
- [ ] 创建CheckinLogs数据表
- [ ] 实现获取签到状态接口 `/checkin/status`
- [ ] 实现每日签到接口 `/checkin`
- [ ] 实现补签功能接口 `/checkin/retroactive`
- [ ] 实现连续签到奖励逻辑

#### 6.2 签到数据管理 ⬜
- [ ] 实现签到日历数据计算
- [ ] 添加签到状态缓存
- [ ] 实现签到奖励发放
- [ ] 编写签到服务相关测试

### 阶段七：排行榜服务模块 (2天)

#### 7.1 排行榜数据管理 ⬜
- [ ] 配置Redis Sorted Set排行榜
- [ ] 实现排行榜数据更新逻辑
- [ ] 实现获取排行榜接口 `/leaderboards/{type}`
- [ ] 实现用户排名查询功能
- [ ] 添加排行榜数据定时更新任务

#### 7.2 排行榜类型支持 ⬜
- [ ] 实现用户积分排行榜
- [ ] 实现宠物等级排行榜
- [ ] 实现好友排行榜(可选)
- [ ] 添加排行榜缓存策略
- [ ] 编写排行榜服务相关测试

### 阶段八：积分商城模块 (3天)

#### 8.1 商品管理 ⬜
- [ ] 创建Products数据表
- [ ] 创建Orders数据表
- [ ] 创建UserInventory数据表
- [ ] 实现获取商品列表接口 `/mall/products`
- [ ] 实现获取商品详情接口 `/mall/products/{product_id}`

#### 8.2 订单处理 ⬜
- [ ] 实现商品兑换接口 `/mall/orders`
- [ ] 实现订单事务处理逻辑
- [ ] 实现用户库存管理
- [ ] 实现获取订单历史接口 `/mall/orders/my_orders`
- [ ] 实现获取用户库存接口 `/mall/inventory/my_inventory`

#### 8.3 积分系统 ⬜
- [ ] 实现积分扣减和增加逻辑
- [ ] 实现库存管理和并发控制
- [ ] 添加订单状态管理
- [ ] 编写商城服务相关测试

### 阶段九：通知服务模块 (1-2天)

#### 9.1 微信订阅消息 ⬜
- [ ] 配置微信订阅消息服务
- [ ] 实现消息模板管理
- [ ] 实现订阅消息发送接口
- [ ] 配置消息队列处理
- [ ] 实现消息发送日志记录

#### 9.2 通知管理 ⬜
- [ ] 实现通知设置管理
- [ ] 实现消息发送状态跟踪
- [ ] 添加消息发送频率限制
- [ ] 编写通知服务相关测试

### 阶段十：系统优化和部署 (2-3天)

#### 10.1 性能优化 ⬜
- [ ] 添加数据库查询优化
- [ ] 实现Redis缓存策略
- [ ] 添加API响应时间监控
- [ ] 实现数据库连接池优化
- [ ] 添加内存使用监控

#### 10.2 安全加固 ⬜
- [ ] 实现API限流中间件
- [ ] 添加输入参数验证
- [ ] 实现SQL注入防护
- [ ] 配置HTTPS和安全头
- [ ] 添加敏感数据加密

#### 10.3 部署配置 ⬜
- [ ] 创建Docker配置文件
- [ ] 配置docker-compose开发环境
- [ ] 创建生产环境部署脚本
- [ ] 配置CI/CD流水线
- [ ] 添加健康检查接口

#### 10.4 监控和日志 ⬜
- [ ] 配置应用日志记录
- [ ] 实现错误监控和告警
- [ ] 添加性能指标收集
- [ ] 配置日志轮转和清理
- [ ] 实现系统状态监控

### 阶段十一：测试和文档 (1-2天)

#### 11.1 测试完善 ⬜
- [ ] 完善单元测试覆盖率
- [ ] 编写集成测试用例
- [ ] 实现API自动化测试
- [ ] 添加性能测试
- [ ] 编写测试文档

#### 11.2 文档完善 ⬜
- [ ] 完善API文档(Swagger)
- [ ] 编写部署文档
- [ ] 创建开发者指南
- [ ] 编写故障排查文档
- [ ] 更新README文档

## 开发规范

### 代码规范
- 使用TypeScript严格模式
- 遵循ESLint和Prettier配置
- 使用统一的命名规范
- 添加完整的JSDoc注释
- 遵循SOLID设计原则

### Git规范
- 使用语义化提交信息
- 每个功能使用独立分支开发
- 代码合并前必须通过Code Review
- 保持提交历史清晰

### 测试规范
- 核心业务逻辑必须有单元测试
- API接口必须有集成测试
- 测试覆盖率不低于80%
- 使用Mock数据进行测试

## 风险评估

### 技术风险
- AI服务集成可能存在延迟和稳定性问题
- 微信API调用限制可能影响用户体验
- 数据库性能在高并发下可能成为瓶颈

### 时间风险
- AI服务开发可能需要额外时间
- 第三方服务集成可能遇到文档不完整问题
- 性能优化可能需要多轮迭代

### 解决方案
- 提前准备AI服务的备选方案
- 实现微信API调用的重试和降级机制
- 设计数据库分片和缓存策略
- 预留20%的缓冲时间

## 里程碑

- **里程碑1** (第3天): 完成项目基础设施和用户认证
- **里程碑2** (第8天): 完成核心宠物功能
- **里程碑3** (第12天): 完成所有业务功能模块
- **里程碑4** (第15天): 完成系统优化和部署准备
- **里程碑5** (第17天): 完成测试和文档，项目交付

## 当前进度总结

### 已完成阶段
- ✅ **阶段一：项目基础设施搭建** - 项目初始化完成，数据库和中间件配置已完成
- ✅ **阶段二：用户认证系统** - 用户认证服务和数据模型已完成
- ✅ **阶段三：用户服务模块** - 用户信息管理和文件上传服务已完成

### 当前任务
- 🔄 **阶段四：宠物服务模块** - 即将开始宠物数据模型和生成功能开发

### 下一步计划
1. 创建宠物数据模型和MongoDB集合
2. 实现宠物生成功能和AI服务集成
3. 实现宠物信息管理接口
4. 开始宠物互动功能开发

## 总结

本开发规划涵盖了萌宠伙伴微信小程序后端的完整开发流程，从基础设施搭建到最终部署。预计总开发时间为15-17个工作日。每个阶段都有明确的任务清单和验收标准，确保开发进度可控和质量可靠。

开发过程中将严格遵循代码规范和测试要求，确保代码质量和系统稳定性。同时考虑了潜在的技术风险和时间风险，制定了相应的解决方案。